<!doctype html>
<script src='../lib/webaudiox.shim.js'></script>
<script src='../lib/webaudiox.lineout.js'></script>
<script src='../lib/webaudiox.loadbuffer.js'></script>
<script src='../lib/webaudiox.analyseraverage.js'></script>

<script src='../lib/webaudiox.bytetonormalizedfloat32array.js'></script>
<body style='margin: 0; overflow: hidden; background-color: #444444'>
<script>
	var context	= new AudioContext()

	// Create lineOut
	var lineOut	= new WebAudiox.LineOut(context)
	lineOut.volume	= 0.2

	// http://www.smartjava.org/content/exploring-html5-web-audio-visualizing-sound

	var analyser	= context.createAnalyser()
console.log('analyser', analyser)
	analyser.smoothingTimeConstant	= 0.2;
	analyser.fftSize	= 512;
	analyser.connect(lineOut.destination);
	lineOut.destination	= analyser;

	// load a sound and play it immediatly
	WebAudiox.loadBuffer(context, 'sounds/Cissy_Strut_Edit.mp3', function(buffer){
		var source	= context.createBufferSource();
		source.buffer	= buffer;
		source.loop	= true
		source.connect(lineOut.destination);
		source.start(0);		
	});
	
	// get microphone as source
	// navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
	// navigator.getUserMedia( {audio:true}, 	function gotStream(stream) {
	// 	// Create an AudioNode from the stream.
	// 	var source	= context.createMediaStreamSource( stream );
		
	// 	source.connect(lineOut.destination);
	// });	
	
	
	
	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////

// TODO put that in a helpers

	// create and add the canvas
	var canvas	= document.createElement('canvas');
	canvas.width	= window.innerWidth;
	canvas.height	= window.innerHeight;
	var ctx		= canvas.getContext("2d");  
	document.body.appendChild(canvas)
	
	var gradient	= ctx.createLinearGradient(0,0,0,canvas.height);
	gradient.addColorStop(1.00,'#000000');
	gradient.addColorStop(0.75,'#ff0000');
	gradient.addColorStop(0.25,'#ffff00');
	gradient.addColorStop(0.00,'#ffffff');

	var smoothedVolume	= null

	requestAnimationFrame(function update() {
		requestAnimationFrame(update);

		// clear the canvas
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		//////////////////////////////////////////////////////////////////////////////////
		//		comment								//
		//////////////////////////////////////////////////////////////////////////////////

		// compute the volume		
		var volume	= WebAudiox.analyserAverage(analyser)
		// draw a circle
		var radius	= 1+volume * 400
		ctx.beginPath()
		ctx.arc(canvas.width*1.5/2, canvas.height*0.5/2, radius, 0, Math.PI*2, true)
		ctx.closePath()
		ctx.fill()


		// compute smoothedVolume
		if( smoothedVolume === null )	smoothedVolume	= volume
		smoothedVolume	+= (volume  - smoothedVolume) * 0.1

		// draw a circle
		var radius	= 1+smoothedVolume * 400
		ctx.beginPath()
		ctx.arc(canvas.width*1.5/2, canvas.height*0.5/2, radius, 0, Math.PI*2, true)
		ctx.closePath()
		ctx.stroke()

		//////////////////////////////////////////////////////////////////////////////////
		//		display	ByteFrequencyData					//
		//////////////////////////////////////////////////////////////////////////////////

		// get the average for the first channel
		var freqData	= new Uint8Array(analyser.frequencyBinCount)
		analyser.getByteFrequencyData(freqData)
		// normalized
		var histogram	= new Float32Array(10)
		WebAudiox.ByteToNormalizedFloat32Array(freqData, histogram)
		// draw the spectrum
		var barStep	= canvas.width / histogram.length
		var barWidth	= barStep*0.8
		ctx.fillStyle	= gradient
		for(var i = 0; i < histogram.length; i++){
			ctx.fillRect(i*barStep, (1-histogram[i])*canvas.height, barWidth, canvas.height)
		}
		
		//////////////////////////////////////////////////////////////////////////////////
		//		display ByteTimeDomainData					//
		//////////////////////////////////////////////////////////////////////////////////
		
		ctx.lineWidth	= 5;
		ctx.strokeStyle = "rgb(255, 255, 255)";
		// get the average for the first channel
		var timeData	= new Uint8Array(analyser.fftSize)
		analyser.getByteTimeDomainData(timeData)
		// normalized
		var histogram	= new Float32Array(60)
		WebAudiox.ByteToNormalizedFloat32Array(timeData, histogram)
		// amplify the histogram
		for(var i = 0; i < histogram.length; i++) {
			histogram[i]	= (histogram[i]-0.5)*1.5+0.5
		}
		// draw the spectrum		
		var barStep	= canvas.width / histogram.length
		ctx.beginPath()
		for(var i = 0; i < histogram.length; i++) {
			histogram[i]	= (histogram[i]-0.5)*1.5+0.5
			ctx.lineTo(i*barStep, (1-histogram[i])*canvas.height)
		}
		ctx.stroke()
	})
</script></body>
